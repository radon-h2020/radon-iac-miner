[{"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "BSD: drop support for log files, change default DataDir location to avoid permission conflicts with the packages (fixes #59)", "sha": "b5d6f33218259b7205796d55ad4b976d3b9f3305", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/b5d6f33218259b7205796d55ad4b976d3b9f3305", "parents": ["fa66f2d6f5193cce5c2f9086e78f9bff39133e60"], "files": [{"sha": "167e44f8652d0288e4728fec053960f6b6cbf7fa", "filename": "tasks/configure.yml", "previous_filename": null, "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/configure.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/configure.yml", "status": "modified", "patch": "@@ -180,33 +180,6 @@\n     group={{ tor_user }}\n     mode=755\n \n-- name: Ensure LogDir exists\n-  become: yes\n-  file: path={{ tor_LogDir }}\n-    state=directory\n-    owner=root\n-    mode=755\n-  when: ansible_system != 'Linux'\n-\n-# we only use distinct logfiles on systems that have no SyslogIdentityTag support yet (all non-Debian plaforms)\n-# otherwise we log to syslog with SyslogIdentityTag to avoid the filesystem permissions troubles with logrotate.\n-# We aim to log to syslog+SyslogIdentityTag for all platforms eventually.\n-# This is a medium-term workaround until all platform get SyslogIdentityTag support\n-# without this workaround tor will fail to start after logrotate created new logfiles because\n-# logrotate is not not aware that every tor instance runs under a distinct user.\n-# This effectively disables logrotate.\n-- name: Ensure per-instance LogDir exists\n-  become: yes\n-  file: path={{ tor_LogDir }}/{{ item[0] }}_{{ item.1.orport }}\n-    state=directory\n-    owner=_tor-{{ item[0] }}_{{ item.1.orport }}\n-    group=_tor-{{ item[0] }}_{{ item.1.orport }}\n-    mode=700\n-  with_nested:\n-   - tor_ips\n-   - tor_ports\n-  when: ansible_system != 'Linux'\n-\n - name: Generating torrc file(s)\n   become: yes\n   template: >"}, {"sha": "857baff789042ceb93356c9ccbeff3052c5f6d46", "filename": "tasks/freebsd_install.yml", "previous_filename": null, "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/freebsd_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/freebsd_install.yml", "status": "modified", "patch": "@@ -2,7 +2,7 @@\n \n - name: Setup FreeBSD specific variables (set_fact)\n   set_fact:\n-    tor_DataDir: /var/db/tor\n+    tor_DataDir: /var/db/tor-instances\n     tor_ConfDir: /usr/local/etc/tor/enabled\n   tags:\n    - reconfigure\n@@ -21,11 +21,6 @@\n    - tor_ips\n    - tor_ports\n \n-- name: If LogDir is a file, rename it (FreeBSD)\n-  become: yes\n-  shell: \"test -f {{ tor_LogDir }} && mv {{ tor_LogDir }} {{ tor_LogDir }}.bk-`date '+%Y-%m-%d_%H%M%S'`\"\n-  ignore_errors: yes\n-\n - name: Ensure sequential IP IDs are avoided (net.inet.ip.random_id)\n   become: yes\n   sysctl: name=net.inet.ip.random_id value=1 reload=no sysctl_set=yes"}, {"sha": "3f58f5380a772b43005b4700b11af8649c790b8a", "filename": "tasks/openbsd_install.yml", "previous_filename": null, "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/openbsd_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/b5d6f33218259b7205796d55ad4b976d3b9f3305/tasks/openbsd_install.yml", "status": "modified", "patch": "@@ -2,7 +2,7 @@\n \n - name: Setup OpenBSD specific variables (set_fact)\n   set_fact:\n-    tor_DataDir: /var/tor\n+    tor_DataDir: /var/tor-instances\n     tor_ConfDir: /etc/tor/enabled\n   tags:\n    - reconfigure"}]}, {"repo": "nusenu/ansible-relayor", "author_id": "MDQ6VXNlcjExMTY1ODQ4", "author_name": "nusenu", "committer_id": "MDQ6VXNlcjExMTY1ODQ4", "committer_name": "nusenu", "committer_email": "nusenu-github@riseup.net", "message": "fix ansible-lint spacing [E206] (#193)", "sha": "9f2f1160c4dc3fea2f6e81e42ba8a6254ef093db", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/9f2f1160c4dc3fea2f6e81e42ba8a6254ef093db", "parents": ["7f02cba4441b5367d6916857c9b41f3abae915db"], "files": [{"sha": "27d3f5f8c4469632bd158d52f5894919e55ae7cc", "filename": "tasks/ip-list.yml", "previous_filename": null, "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/9f2f1160c4dc3fea2f6e81e42ba8a6254ef093db/tasks/ip-list.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/9f2f1160c4dc3fea2f6e81e42ba8a6254ef093db/tasks/ip-list.yml", "status": "modified", "patch": "@@ -14,7 +14,7 @@\n \n - name: workaround for ansible bug 14829 (2/3)\n   set_fact:\n-    tor_v6ips: \"{{ tor_available_public_ipv6s[0:tor_ipv4_count|int]|ipv6('address') }}\"\n+    tor_v6ips: \"{{ tor_available_public_ipv6s[0:tor_ipv4_count|int] | ipv6('address') }}\"\n \n - name: workaround for ansible bug 14829 (3/3)\n   set_fact:\n@@ -33,4 +33,4 @@\n \n - name: setup IP list (2/2)\n   set_fact:\n-    tor_ips: \"{{ tor_ipsinterm.results | map(attribute='ansible_facts.ips')|list}}\"\n+    tor_ips: \"{{ tor_ipsinterm.results | map(attribute='ansible_facts.ips') | list }}\""}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "don't fail on CentOS with SELinux disabled (fixes #42)", "sha": "33341b8cd483ae2583a4bd7c1bd79c82e4a12e4b", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/33341b8cd483ae2583a4bd7c1bd79c82e4a12e4b", "parents": ["8cf75eb68465f1126872131afd102e05068a9df2"], "files": [{"sha": "4c996ca850c8faf1b20f4a6b7afe7ddfbf32e62e", "filename": "tasks/yum_install.yml", "previous_filename": null, "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/33341b8cd483ae2583a4bd7c1bd79c82e4a12e4b/tasks/yum_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/33341b8cd483ae2583a4bd7c1bd79c82e4a12e4b/tasks/yum_install.yml", "status": "modified", "patch": "@@ -26,6 +26,7 @@\n - name: Ensure setsebool (SELinux) dependencies are installed (CentOS)\n   sudo: yes\n   yum: name=libsemanage-python state=present\n+  when: ansible_selinux.status == 'enabled'\n \n - name: Ensure the presence of the multi-instance systemd unit file (CentOS)\n   sudo: yes\n@@ -35,5 +36,6 @@\n - name: Ensure SELinux boolean (tor_can_network_relay) is set appropriately (CentOS)\n   sudo: yes\n   seboolean: name=tor_can_network_relay state=yes persistent=yes\n+  when: ansible_selinux.status == 'enabled'\n \n - meta: flush_handlers"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "including OS specific vars is always required (fixes #86)", "sha": "dbe5647c4e42252e9e428e50b9b0a3636f94842a", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/dbe5647c4e42252e9e428e50b9b0a3636f94842a", "parents": ["2a8ca91248bb834daaa8c35f709d6f8158d81a38"], "files": [{"sha": "85b96a58a39f2e87779d5a98a40f2dcb9862d8f1", "filename": "tasks/main.yml", "previous_filename": null, "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/dbe5647c4e42252e9e428e50b9b0a3636f94842a/tasks/main.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/dbe5647c4e42252e9e428e50b9b0a3636f94842a/tasks/main.yml", "status": "modified", "patch": "@@ -11,8 +11,7 @@\n - name: Set OS specific variables\n   include_vars: \"{{ ansible_os_family }}.yml\"\n   tags:\n-   - renewkey\n-   - reconfigure\n+   - always\n \n - include: ip-list.yml\n   tags:"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "CentOS/Fedora: move DataDirs to /var/lib/tor-instances (fixes #58)\n\nmake sure SELinux type is set properly on /var/lib/tor-instances\n\nallow the systemd service to write to /var/lib/tor-instances (drop-in)\nThanks to Jamie Nguyen for suggesting that fix.\n\nlog via syslog on Linux systems", "sha": "51dcdf691a7801895b569a5a927e30030d8feb70", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/51dcdf691a7801895b569a5a927e30030d8feb70", "parents": ["95a0ffb87f5a5ecbf178ee4a5b4f890acaba6cbe"], "files": [{"sha": "8d16346f0b8e9948b65bf34e38a532d416e5ceb1", "filename": "tasks/rpm_install.yml", "previous_filename": null, "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/51dcdf691a7801895b569a5a927e30030d8feb70/tasks/rpm_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/51dcdf691a7801895b569a5a927e30030d8feb70/tasks/rpm_install.yml", "status": "modified", "patch": "@@ -5,9 +5,11 @@\n     tor_user: toranon\n     tor_ConfDir: /etc/tor\n     tor_RunAsDaemon: 0\n+    tor_DataDir: /var/lib/tor-instances\n   tags:\n    - reconfigure\n    - renewkey\n+   - createdir\n \n - name: Ensure tor package is installed (dnf)\n   become: yes\n@@ -34,3 +36,22 @@\n   seboolean: name=tor_can_network_relay state=yes persistent=yes\n   when: ansible_selinux.status == 'enabled'\n \n+- name: Ensure systemd drop-in folder is present\n+  become: yes\n+  file: path=/etc/systemd/system/tor@.service.d\n+    state=directory\n+    owner=root\n+    mode=0755\n+\n+# this is needed for a small service file modification (allow it to write to /var/lib/tor-instances)\n+# without replacing the maintainer's file, for details see\n+# http://www.freedesktop.org/software/systemd/man/systemd.unit.html#id-1.11.3\n+- name: Ensure service file drop-in is present\n+  become: yes\n+  copy: src=local.conf\n+   dest=/etc/systemd/system/tor@.service.d/local.conf\n+   owner=root\n+   mode=640\n+  notify: systemctl daemon-reload\n+\n+- meta: flush_handlers"}, {"sha": "47d0b3c467647d4a309f7231d0a976906113bee3", "filename": "tasks/configure.yml", "previous_filename": null, "additions": 19, "deletions": 16, "changes": 35, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/51dcdf691a7801895b569a5a927e30030d8feb70/tasks/configure.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/51dcdf691a7801895b569a5a927e30030d8feb70/tasks/configure.yml", "status": "modified", "patch": "@@ -83,20 +83,6 @@\n   tags:\n    - createdir\n \n-- name: Ensure per-instance DataDir exists\n-  become: yes\n-  file: path={{ tor_DataDir }}/{{ item[0] }}_{{ item.1.orport }}\n-    state=directory\n-    owner=\"_tor-{{ item[0] }}_{{ item.1.orport }}\"\n-    group=\"_tor-{{ item[0] }}_{{ item.1.orport }}\"\n-    mode=0700\n-    recurse=yes\n-  with_nested:\n-   - \"{{ tor_ips }}\"\n-   - \"{{ tor_ports }}\"\n-  tags:\n-   - createdir\n-\n - name: Ensure \"keys\" subfolder exists\n   become: yes\n   file: path={{ tor_DataDir }}/{{ item[0] }}_{{ item.1.orport }}/keys\n@@ -162,13 +148,30 @@\n    dest={{ tor_DataDir }}/{{ item[0] }}_{{ item.1.orport }}/keys/{{ item[2] }}\n    owner=\"_tor-{{ item[0] }}_{{ item.1.orport }}\"\n    mode=700\n+   setype=tor_var_lib_t\n   with_nested:\n    - \"{{ tor_ips }}\"\n    - \"{{ tor_ports }}\"\n    - [ 'ed25519_master_id_public_key', 'ed25519_signing_cert', 'ed25519_signing_secret_key' ]\n   tags:\n    - renewkey\n \n+# This needs to be at the end to fix SELinux contexts recursively\n+- name: Ensure per-instance DataDir exists\n+  become: yes\n+  file: path={{ tor_DataDir }}/{{ item[0] }}_{{ item.1.orport }}\n+    state=directory\n+    owner=\"_tor-{{ item[0] }}_{{ item.1.orport }}\"\n+    group=\"_tor-{{ item[0] }}_{{ item.1.orport }}\"\n+    mode=0700\n+    recurse=yes\n+    setype=tor_var_lib_t\n+  with_nested:\n+   - \"{{ tor_ips }}\"\n+   - \"{{ tor_ports }}\"\n+  tags:\n+   - createdir\n+\n - name: Ensure Tor config directory exists\n   become: yes\n   file: path={{ tor_ConfDir }}\n@@ -183,7 +186,7 @@\n     state=directory\n     owner=root\n     mode=755\n-  when: ansible_pkg_mgr != 'apt'\n+  when: ansible_system != 'Linux'\n \n # we only use distinct logfiles on systems that have no SyslogIdentityTag support yet (all non-Debian plaforms)\n # otherwise we log to syslog with SyslogIdentityTag to avoid the filesystem permissions troubles with logrotate.\n@@ -202,7 +205,7 @@\n   with_nested:\n    - tor_ips\n    - tor_ports\n-  when: ansible_pkg_mgr != 'apt'\n+  when: ansible_system != 'Linux'\n \n - name: Generating torrc file(s)\n   become: yes"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "add support for private IPv4 addresses (fixes #102)\n\nUse public IPs only by default and fallback\nto a single private IP in case we have no public IP.\nUsing public _and_ private IPv4 addresses at the same\ntime on a single host is not supported.\n\nFixes a bug where we created more than two\ntor instances per public IPv4 address when the\nhost had private and public IPv4 addresses.\n\nVariable 'tor_v4ips' can no longer be set since it is\npotentially overwritten at runtime.\n\ntor_maxips is replaced with tor_maxPublicIPs + tor_maxPrivateIPs\n\ntorrc: no longer include 'Address' line.\n\nThis would be simpler without bug ansible/ansible#14829 (#80).", "sha": "1224adf2811c827a09ff0bf133fbb476901a547d", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/1224adf2811c827a09ff0bf133fbb476901a547d", "parents": ["f5364b57f100ae9fa898af59b7812ec0c447ac42"], "files": [{"sha": "1988f01ef9d24891230f86caf9f6bb0c5d99b828", "filename": "tasks/ip-list.yml", "previous_filename": null, "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/1224adf2811c827a09ff0bf133fbb476901a547d/tasks/ip-list.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/1224adf2811c827a09ff0bf133fbb476901a547d/tasks/ip-list.yml", "status": "modified", "patch": "@@ -1,5 +1,9 @@\n ---\n \n+- name: Use a single private IPv4 address if we have no public IPv4 address\n+  include_vars: private_IPv4_only.yml\n+  when: tor_v4ips == []\n+\n # workaround for this ansible IPv6 filter bug\n # https://github.com/ansible/ansible/issues/14829\n # we simply convert False to empty lists"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "Debian: allow \"_\" and \".\" in instance names, so our instances are started properly after package upgrade (fixes #72)", "sha": "0406395a8758f12abd57914532cc0ff17894d015", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/0406395a8758f12abd57914532cc0ff17894d015", "parents": ["32211ebd2a9f45112f8dceda80bc95d0db029fb4"], "files": [{"sha": "ffad5368a5a2f427dd880a5eab0d98ef0af0eeca", "filename": "tasks/apt_install.yml", "previous_filename": null, "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/0406395a8758f12abd57914532cc0ff17894d015/tasks/apt_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/0406395a8758f12abd57914532cc0ff17894d015/tasks/apt_install.yml", "status": "modified", "patch": "@@ -35,6 +35,25 @@\n   notify:\n     - stop-and-mask default tor instance\n \n+# Background:\n+# https://github.com/nusenu/ansible-relayor/issues/72\n+- name: Ensure systemd generator folder exists (Debian Testing and Ubuntu)\n+  become: yes\n+  file: path=/etc/systemd/system-generators state=directory mode=755\n+  when: ansible_lsb.codename != 'jessie'\n+\n+- name: Ensure custom systemd generator is in place (Debian/Ubuntu only)\n+  become: yes\n+  copy: src=tor-generator\n+   dest=\"{{ (ansible_lsb.codename == 'jessie')|ternary('/lib/systemd/system-generators/relayor-generator', '/etc/systemd/system-generators/tor-generator') }}\"\n+   owner=root\n+   mode=755\n+\n+- name: Ensure the maintainer's generator is disabled (Debian 8 only)\n+  become: yes\n+  command: dpkg-statoverride --update --add root root 644 /lib/systemd/system-generators/tor-generator\n+  when: ansible_lsb.codename == 'jessie'\n+\n \n #- name: Ensure AppArmor allows access to necessary files (Ubuntu)\n #  become: yes"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "remove task 'Check for local requirements' (fixes #96)\n\nit does not work on macOS (the only platform it was written for)", "sha": "196c5c74623fe97d88ea1e2527b96d7ccef784a5", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/196c5c74623fe97d88ea1e2527b96d7ccef784a5", "parents": ["8af8d9f258ac145b451e2f0db433e5e9ad335ea2"], "files": [{"sha": "d98ea2a48d9f37fc6707bb9161c2400c1679169c", "filename": "tasks/main.yml", "previous_filename": null, "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/196c5c74623fe97d88ea1e2527b96d7ccef784a5/tasks/main.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/196c5c74623fe97d88ea1e2527b96d7ccef784a5/tasks/main.yml", "status": "modified", "patch": "@@ -10,13 +10,6 @@\n   tags:\n     - always\n \n-- name: Check for local requirements\n-  shell: tor --version && sha1sum --version && sort --version && uniq --version && wc --version && cut --version\n-  run_once: true\n-  delegate_to: 127.0.0.1\n-  tags:\n-    - always\n-\n - name: Set OS specific variables\n   include_vars: \"{{ ansible_os_family }}.yml\"\n   tags:"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "bugfix: make conditional service reload after torrc change a handler (fixes #83)", "sha": "c25e1f96cb3a91dfef803f4de935c51c597bd19d", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/c25e1f96cb3a91dfef803f4de935c51c597bd19d", "parents": ["dc73f16743fa376672b427980c6ca044dd6fa68a"], "files": [{"sha": "5e3caef9204c63c07f638687fa38ac81774205e4", "filename": "handlers/main.yml", "previous_filename": null, "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/c25e1f96cb3a91dfef803f4de935c51c597bd19d/handlers/main.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/c25e1f96cb3a91dfef803f4de935c51c597bd19d/handlers/main.yml", "status": "modified", "patch": "@@ -31,3 +31,11 @@\n     name: tor\n     state: reloaded\n   when: ansible_system == 'FreeBSD'\n+\n+- name: Ensure Tor instances are reloaded if its torrc changed (Linux)\n+  become: yes\n+  service:\n+    name: \"tor@{{ item.item.0.ipv4 }}_{{ item.item.1.orport }}.service\"\n+    state: reloaded\n+  with_items: \"{{ instances.results }}\"\n+  when: item.changed == True and ansible_system == 'Linux'"}, {"sha": "40c2a0aab1694994d5a45958f0086449cf1d43e4", "filename": "tasks/linux_service.yml", "previous_filename": null, "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/c25e1f96cb3a91dfef803f4de935c51c597bd19d/tasks/linux_service.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/c25e1f96cb3a91dfef803f4de935c51c597bd19d/tasks/linux_service.yml", "status": "modified", "patch": "@@ -3,16 +3,6 @@\n # Linux/systemd section (uses service module)\n # ===========================================\n \n-- name: Ensure Tor instances are reloaded if its torrc changed (Linux/systemd)\n-  become: yes\n-  service:\n-    name: \"tor@{{ item.item.0.ipv4 }}_{{ item.item.1.orport }}.service\"\n-    state: reloaded\n-  with_items: \"{{ instances.results }}\"\n-  when: item.changed == True\n-  tags:\n-   - reconfigure\n-\n - name: Ensure Tor instances are enabled and started (Linux/systemd)\n   become: yes\n   service:"}, {"sha": "653500718877a2fa7023080e141f21c83078bb45", "filename": "tasks/configure.yml", "previous_filename": null, "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/c25e1f96cb3a91dfef803f4de935c51c597bd19d/tasks/configure.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/c25e1f96cb3a91dfef803f4de935c51c597bd19d/tasks/configure.yml", "status": "modified", "patch": "@@ -214,5 +214,6 @@\n   register: instances\n   notify:\n     - Ensure Tor instances are reloaded if its torrc changed (FreeBSD)\n+    - Ensure Tor instances are reloaded if its torrc changed (Linux)\n   tags:\n    - reconfigure"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "fix for #11\nThis avoids troubles if the relay operator migrated the datadir\nfrom another server but forgot to fix filepermissions.", "sha": "25268594e4bf662f487ddd8792c22b93b27160fc", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/25268594e4bf662f487ddd8792c22b93b27160fc", "parents": ["7a3aa0de9bf76ff1b18e6da304031150e4550142"], "files": [{"sha": "492991728f4d67dbfeefed516a2998d2d43791eb", "filename": "tasks/configure.yml", "previous_filename": null, "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/25268594e4bf662f487ddd8792c22b93b27160fc/tasks/configure.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/25268594e4bf662f487ddd8792c22b93b27160fc/tasks/configure.yml", "status": "modified", "patch": "@@ -6,6 +6,7 @@\n     state=directory\n     owner={{ tor_user }}\n     mode=0700\n+    recurse=yes\n   with_nested:\n    - \"{{ tor_ips }}\"\n    - \"{{ tor_ports }}\""}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "OpenBSD: tor was not started appropriately with \"-f config\" during initial install due to an ordering issue (closes #34)", "sha": "850b64e62ec69d7b4d32f0ad9258e608b0e50ca2", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/850b64e62ec69d7b4d32f0ad9258e608b0e50ca2", "parents": ["72a9fefcabb6edccd82abb23946bd305035db334"], "files": [{"sha": "44617d6949d8b6bf3e0ad200b6f158d7436a298a", "filename": "tasks/configure.yml", "previous_filename": null, "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/850b64e62ec69d7b4d32f0ad9258e608b0e50ca2/tasks/configure.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/850b64e62ec69d7b4d32f0ad9258e608b0e50ca2/tasks/configure.yml", "status": "modified", "patch": "@@ -148,15 +148,6 @@\n   tags:\n    - openbsd\n \n-- name: Ensure Tor instances are reloaded if its torrc changed (OpenBSD)\n-  sudo: yes\n-  service: name=tor{{ item.item[0]|replace('.','_') }}_{{ item.item.1.orport }} state=reloaded\n-  with_items: instances.results\n-  when: ansible_system == 'OpenBSD' and item.changed == True\n-  tags:\n-   - openbsd\n-   - configure\n-\n - name: Ensure Tor instances are enabled and started (OpenBSD)\n   sudo: yes\n   service: name=tor{{ item[0]|replace('.','_') }}_{{ item.1.orport }}\n@@ -168,6 +159,15 @@\n   tags:\n    - openbsd\n \n+- name: Ensure Tor instances are reloaded if its torrc changed (OpenBSD)\n+  sudo: yes\n+  service: name=tor{{ item.item[0]|replace('.','_') }}_{{ item.item.1.orport }} state=reloaded\n+  with_items: instances.results\n+  when: ansible_system == 'OpenBSD' and item.changed == True\n+  tags:\n+   - openbsd\n+   - configure\n+\n \n # FreeBSD section\n # ================"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "FreeBSD: change pidir from /var/run/tor to /var/run/tor-instances (fixes #62)", "sha": "44be91805d4a4c003d28a7c5fd3f7a6317863435", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/44be91805d4a4c003d28a7c5fd3f7a6317863435", "parents": ["694a4890fcf0daa375d6a173511f6ff7dd0f2335"], "files": [{"sha": "ecd05ee5fa3c823f5d4ecd97f24f5af00a50fb06", "filename": "tasks/freebsd_install.yml", "previous_filename": null, "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/44be91805d4a4c003d28a7c5fd3f7a6317863435/tasks/freebsd_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/44be91805d4a4c003d28a7c5fd3f7a6317863435/tasks/freebsd_install.yml", "status": "modified", "patch": "@@ -4,6 +4,7 @@\n   set_fact:\n     tor_DataDir: /var/db/tor-instances\n     tor_ConfDir: /usr/local/etc/tor/enabled\n+    tor_PidDir: /var/run/tor-instances\n   tags:\n    - reconfigure\n    - renewkey"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "OpenBSD: fix a bug in openfiles-max handling (closes #37) Users of previous versions can remove the line \"tordaemon::openfiles-max=13500::tc=daemon:\" from their /etc/login.conf files", "sha": "c5b489aa56c545dd0b51910b5a0d701d838ff071", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/c5b489aa56c545dd0b51910b5a0d701d838ff071", "parents": ["12d2d30c292e5749809cd7476458762a4de31554"], "files": [{"sha": "3929e7fce2cbb6891d2f9e994ddd158f933f973e", "filename": "tasks/openbsd_install.yml", "previous_filename": null, "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/c5b489aa56c545dd0b51910b5a0d701d838ff071/tasks/openbsd_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/c5b489aa56c545dd0b51910b5a0d701d838ff071/tasks/openbsd_install.yml", "status": "modified", "patch": "@@ -32,14 +32,13 @@\n   lineinfile: dest=/etc/sysctl.conf regexp=^kern.maxfiles line=\"kern.maxfiles=20000\" create=yes\n   when: currentlimits.stdout|int < 20000\n \n+# We rise openfiles limits for every tor instance separately.\n+# An instance is identified by its rc.d file name.\n - name: Ensure Tor process file descriptor limits are reasonable (OpenBSD)\n   sudo: yes\n-  lineinfile: \"dest=/etc/login.conf line='{{ tor_loginclass }}::openfiles-max=13500::tc=daemon:'\"\n+  lineinfile: \"dest=/etc/login.conf line='tor{{ item[0]| replace('.','_') }}_{{ item.1.orport }}::openfiles-max=13500::tc=daemon:'\"\n+  with_nested:\n+   - tor_ips\n+   - tor_ports\n   #TODO\n   #notify: restart tor\n-\n-- name: Ensure 'tor_user' has appropriate login class set (OpenBSD)\n-  sudo: yes\n-  user: name={{ tor_user }} login_class={{ tor_loginclass }}\n-  #TODO \n-  #notify: restart tor"}]}, {"repo": "nusenu/ansible-relayor", "author_id": null, "author_name": "nusenu", "committer_id": null, "committer_name": "nusenu", "committer_email": "nusenu@openmailbox.org", "message": "Fedora: make use of systemd hardening features (also fixes #53 with RestartSec=1, thanks to Jamie Nguyen)", "sha": "2149edf99fe1c251d0eaad5c78536c9b1d54dde3", "url": "https://api.github.com/repos/nusenu/ansible-relayor/commits/2149edf99fe1c251d0eaad5c78536c9b1d54dde3", "parents": ["df06f3c3304c3f73f740d444222642fbad41bebb"], "files": [{"sha": "52ea222a49ca8c3a688c20c74e90922416a662a1", "filename": "tasks/dnf_install.yml", "previous_filename": null, "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/nusenu/ansible-relayor/blob/2149edf99fe1c251d0eaad5c78536c9b1d54dde3/tasks/dnf_install.yml", "raw_url": "https://github.com/nusenu/ansible-relayor/raw/2149edf99fe1c251d0eaad5c78536c9b1d54dde3/tasks/dnf_install.yml", "status": "modified", "patch": "@@ -30,7 +30,7 @@\n \n - name: Ensure the presence of the multi-instance systemd unit file (Fedora)\n   become: yes\n-  copy: src=centos_tor@.service dest=/lib/systemd/system/tor@.service owner=root mode=0644 backup=yes setype=tor_unit_file_t\n+  copy: src=fedora_tor@.service dest=/lib/systemd/system/tor@.service owner=root mode=0644 backup=yes setype=tor_unit_file_t\n   notify: systemctl daemon-reload\n \n - name: Ensure SELinux boolean (tor_can_network_relay) is set appropriately (Fedora)"}]}]